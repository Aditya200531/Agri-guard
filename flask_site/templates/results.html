<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
</head>
<body>
    <div class="results-container">
        <div class="top-bar">
            <h1 style="color:#38B2AC;">ðŸŒ± AgriGuard</h1>
            <div class="disease-info">
                <h2>ðŸ”Ž <span>{{ model_output }}</span></h2>
            </div>
        </div>
        <div id="chat-history" class="chat-history">
            {% for message in chat_history %}
                <div class="message {{ 'user' if message.startswith('User:') else 'bot' }}">
                    {% if message.startswith('User:') %}
                        <p>{{ message }}</p>
                    {% else %}
                        <p>{{ message['response'] }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        
        <!-- Chat Form -->
        <form id="chat-form">
            <input type="text" id="user-input" class="chat-input" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </form>
    </div>

    <script>
        // Add animated flourishes
        anime({
            targets: '.top-bar',
            translateY: [-20, 0],
            opacity: [0, 1],
            duration: 800,
            delay: 200,
            easing: 'easeOutExpo'
        });

        anime({
            targets: '.chatbox',
            translateY: [20, 0],
            opacity: [0, 1],
            duration: 800,
            delay: 400,
            easing: 'easeOutExpo'
        });

        anime({
            targets: '.chat-input',
            translateY: [20, 0],
            opacity: [0, 1],
            duration: 800,
            delay: 600,
            easing: 'easeOutExpo'
        });

        // Handle form submission and chat interactions
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const userInput = document.getElementById('user-input').value;
            document.getElementById('user-input').value = ''; // Clear input field

            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_input: userInput })
            })
            .then(response => response.json())
            .then(data => {
                const chatHistory = document.getElementById('chat-history');

                // Append user message
                const userMessage = document.createElement('div');
                userMessage.classList.add('message', 'user');
                userMessage.innerHTML = `<p>User: ${data.user}</p>`;
                chatHistory.appendChild(userMessage);

                // Append bot response as ordered list without periods after the number
                const botMessage = document.createElement('div');
                botMessage.classList.add('message', 'bot');
                const uniqueResponses = new Set(data.bot);
                let number = 1;

                uniqueResponses.forEach(line => {
                    const botResponse = document.createElement('p');
                    botResponse.textContent = `${number} ${line}`; // No period after the number
                    botResponse.style.marginBottom = "10px"; // Add spacing between lines
                    botMessage.appendChild(botResponse);
                    number++; // Increment the number for each line
                });

                chatHistory.appendChild(botMessage);

                // Scroll to the bottom of the chat history
                chatHistory.scrollTop = chatHistory.scrollHeight;
            })
            .catch(err => console.error('Error:', err));
        });
    </script>    
</body>
</html>
